<!DOCTYPE html>
<html>
<head>
  <script src="js/jspsych.js"></script>
  <script src="js/jspsych-stimulus-presentation.js"></script>
  <script src="js/jspsych-instructions.js"></script>
    <script src="js/jspsych-html-keyboard-response.js"></script>
    <script src="js/jspsych-image-keyboard-response.js"></script>
    <script src="js/helper_for_generating_stimuli_array.js"></script>
    <script src="js/helper_for_checking_duplicate_stimuli.js"></script>
  <link rel="stylesheet" href="css/jspsych.css"></link>
</head>
<body></body>
<script>
    
    
    var timenum = Date.now();
    var turkInfo = jsPsych.turk.turkInfo();
    //$.getJSON('https://json.geoiplookup.io/api?callback=?', function(data) {
      //console.log(JSON.stringify(data, null, 2));
     // jsPsych.data.addProperties({ IP: data.ip, country_code: data.country_code });
    //});

    // if we're not on MTurk, create a timestamp-based subject number; otherwise use turker ID
    var subject_id = 'SS' + timenum;
       
    if(turkInfo==null) {
      var subject_id = 'SS' + timenum;
    } else {
      var subject_id = 'MT-' + turkInfo.workerId;
    }
    // store subject in data on every trial
    jsPsych.data.addProperties({ subject: subject_id });

    
  var timeline = []
    
  



// this function random selects [number] of path in the [type] folder and return them in an array    
// the returned array represents all stimuli to be used in a task (5 blocks)

var NUM_SIMPLE_STIMULI = 120
var NUM_COMPLEX_STIMULI = 120


ALL_STIMULI_PATH = get_all_stimuli() // all stimuli 
stimuli_tracker = ALL_STIMULI_PATH // make a copy to keep track of stimuli that has been chosen
    


var simple_test_blocks = create_all_stimuli(meta_stimuli_path = stimuli_tracker, 
                                            type = "all_simple", 
                                            n_trial = 15, 
                                            n_block = 5, 
                                            bkgd_freq = 0.7,
                                            tg_freq = 0.15, 
                                            dvt_freq = 0.15)
stimuli_tracker = simple_test_blocks.remaining_stimuli

var complex_test_blocks = create_all_stimuli(meta_stimuli_path = stimuli_tracker,
                                             type = "all_complex", 
                                            n_trial = 15, 
                                            n_block = 5, 
                                            bkgd_freq = 0.7,
                                            tg_freq = 0.15, 
                                            dvt_freq = 0.15)
stimuli_tracker = complex_test_blocks.remaining_stimuli

var mixed_test_blocks = create_all_stimuli(meta_stimuli_path = stimuli_tracker,
                                           type = "mixed", 
                                           n_trial = 15, 
                                            n_block = 5, 
                                            bkgd_freq = 0.7,
                                            tg_freq = 0.15, 
                                            dvt_freq = 0.15)

// just double check there were no duplicates
var duplicate = check_duplicates([simple_test_blocks, complex_test_blocks, mixed_test_blocks])   
if (duplicate){
    alert("sampling script broken! detect duplicates!")
    assert()    
}

var ALL_TASKS = [simple_test_blocks,
                       complex_test_blocks, mixed_test_blocks]

shuffleArray(ALL_TASKS)
    

    

// minimum presentation time - done 
// various inter stimulus interval -- Done  
// presenting the target stimulus - done 
// presenting the target stimulus response => need to get conditional responses 

var current_block = ALL_TASKS[0] // this will be embedded in a larger loop 

console.log(current_block)
const NUM_BLOCK = 5

for (var task_num = 0; task_num < ALL_TASKS.length; task_num++){

var current_task = ALL_TASKS[task_num]
var current_target = current_task.target    
    
 task_order_print = ""
 if (task_num === 0){
     task_order_print = "first"
 }else if (task_num === 1){
     task_order_print = "second"
 }else if (task_num === 2){
     task_order_print = "last"
 }
    
 var task_instruction = {
     type: "instructions",
     pages:[
         "hello!!!!",
         "look at pictures hahaha it's boring just press the down key", 
         "this is the target picture though press space bar pls" + '<p><img src="'+ current_target + '"></img></p>',
         "three tasks in total, you can take relatively longer break in between, each task has 5 small block, small break haha",
         "nope we will not test you just chill",
     ],
     show_clickable_nav: true
     
 }
 
 timeline.push(task_instruction)


 for (var block_num = 0; block_num < NUM_BLOCK; block_num++){
     
     current_target = current_task.target
     console.log("inner loop")
     console.log(current_target)
    var task_block = {
    timeline: [
        
        {
            type: 'html-keyboard-response',
            stimulus: "",
            trial_duration: function(){ 
                var random_duration = 800 + 500 * Math.random()
                return random_duration  } , //The interval between the offset of one stimulus and the onset of the next stimulus ranged between 800 and 1300 msec
            choices: jsPsych.NO_KEYS
        },
        
        
       
        {
            type: 'stimulus-presentation',
            stimulus: function(){
                var html="<img src='"+jsPsych.timelineVariable('pic', true)+"'>";
                
                return html;
            },
            choices_for_target: [32],
            choices: [40],
            minimum_viewing_duration: 600, // daffner2000's info
            response_ends_trial: true, 
            task_type:current_task.type,
            task_target_stimulus:current_task.target,
         task_background_stimulus:current_task.background,
            task_deviant_stimulus:current_task.deviant,
            task_order_number:0,//to be fixed with larger loop
            block_order_number:block_num
            
            
        }
    ],
        
    timeline_variables: current_task.blocks_info.map(function(item){
    return convert_path_to_timeline_variables(item)
})[block_num], 
    
     
    }
    
   
     
    var break_order = block_num + 1
    var break_block = {
        type: 'html-keyboard-response',
        stimulus: "here's the " + break_order + " break block!",
        trial_duration: 1000,
        choices: jsPsych.NO_KEYS
        
    }
     
     
     
     timeline.push(task_block)
     timeline.push(break_block)
 }
  
}
  

  
  
  
  
  
    
    
    //TO FIX!!!
    function saveData(name, data){
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '../../../cgi-bin/daffner2000/write_data.php'); // langcog server path
        //xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify({filename: name, filedata: data}));
    }
    
    
jsPsych.init({
        timeline: timeline,
        //use_webaudio: true, // this won't work for local testing (CORS), but maybe on server
        //preload_audio: audio,
        //preload_images: images,
        //preload_video: video,
        on_trial_finish: function(){
            saveData("daffnerrep-" + subject_id, jsPsych.data.get().csv());
            jsPsych.data.displayData();
            //setTimeout(function() { turk.submit(jsPsych.data.get().ignore('external-html').json()); }, 5000);
      }
    })

    </script>
</html>