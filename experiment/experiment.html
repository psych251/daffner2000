<!DOCTYPE html>
<html>
<head>
  <script src="js/jspsych.js"></script>
  <script src="js/jspsych-stimulus-presentation.js"></script>
    <script src="js/jspsych-html-keyboard-response.js"></script>
    <script src="js/jspsych-image-keyboard-response.js"></script>
    <script src="js/helper_for_generating_stimuli_array.js"></script>
    <script src="js/helper_for_checking_duplicate_stimuli.js"></script>
  <link rel="stylesheet" href="css/jspsych.css"></link>
</head>
<body></body>
<script>
    
    
    var timenum = Date.now();
    var turkInfo = jsPsych.turk.turkInfo();
    //$.getJSON('https://json.geoiplookup.io/api?callback=?', function(data) {
      //console.log(JSON.stringify(data, null, 2));
     // jsPsych.data.addProperties({ IP: data.ip, country_code: data.country_code });
    //});

    // if we're not on MTurk, create a timestamp-based subject number; otherwise use turker ID
    var subject_id = 'SS' + timenum;
    /*    
    if(turkInfo==null) {
      var subject_id = 'SS' + timenum;
    } else {
      var subject_id = 'MT-' + turkInfo.workerId;
    }
*/
    // store subject in data on every trial
    jsPsych.data.addProperties({ subject: subject_id });

    
  var timeline = []
    
  



// this function random selects [number] of path in the [type] folder and return them in an array    
// the returned array represents all stimuli to be used in a task (5 blocks)

var NUM_SIMPLE_STIMULI = 120
var NUM_COMPLEX_STIMULI = 120


ALL_STIMULI_PATH = get_all_stimuli() // all stimuli 
stimuli_tracker = ALL_STIMULI_PATH // make a copy to keep track of stimuli that has been chosen
    


var simple_test_blocks = create_all_stimuli(meta_stimuli_path = stimuli_tracker, 
                                            type = "all_simple", 
                                            n_trial = 25, 
                                            n_block = 5, 
                                            bkgd_freq = 0.7,
                                            tg_freq = 0.15, 
                                            dvt_freq = 0.15)
stimuli_tracker = simple_test_blocks.remaining_stimuli

var complex_test_blocks = create_all_stimuli(meta_stimuli_path = stimuli_tracker,
                                             type = "all_complex", 
                                            n_trial = 25, 
                                            n_block = 5, 
                                            bkgd_freq = 0.7,
                                            tg_freq = 0.15, 
                                            dvt_freq = 0.15)
stimuli_tracker = complex_test_blocks.remaining_stimuli

var mixed_test_blocks = create_all_stimuli(meta_stimuli_path = stimuli_tracker,
                                           type = "mixed", 
                                           n_trial = 25, 
                                            n_block = 5, 
                                            bkgd_freq = 0.7,
                                            tg_freq = 0.15, 
                                            dvt_freq = 0.15)

// just double check there were no duplicates
var duplicate = check_duplicates([simple_test_blocks, complex_test_blocks, mixed_test_blocks])   
if (duplicate){
    alert("sampling script broken! detect duplicates!")
    assert()    
}

var ALL_TASKS = [simple_test_blocks,
                       complex_test_blocks, mixed_test_blocks]

shuffleArray(ALL_TASKS)
    

    

// minimum presentation time 
// various inter stimulus interval -- Done  
// presenting the target stimulus
// presenting the target stimulus response 

var current_block = ALL_TASKS[0] // this will be embedded in a larger loop 

console.log(current_block)
const NUM_BLOCK = 5

for (var task_num = 0; task_num < ALL_TASKS.length; task_num++){

 for (var block_num = 0; block_num < NUM_BLOCK; block_num++){
    var task_block = {
    timeline: [
        
        {
            type: 'html-keyboard-response',
            stimulus: "",
            trial_duration: function(){ 
                var random_duration = 800 + 500 * Math.random()
                return random_duration  } , //The interval between the offset of one stimulus and the onset of the next stimulus ranged between 800 and 1300 msec
            choices: jsPsych.NO_KEYS
        },
        {
            type: 'stimulus-presentation',
            stimulus: function(){
                var html="<img src='"+jsPsych.timelineVariable('pic', true)+"'>";
                
                return html;
            },          
            choices: [40],
            task_type:current_block.type,
            task_target_stimulus:current_block.tg_stim,
            task_background_stimulus:current_block.bkgd_stim,
            task_deviant_stimulus:current_block.dvt_stim_selected,
            task_order_number:0,//to be fixed with larger loop
            block_order_number:block_num
            
            
        }
    ],
        
    timeline_variables: current_block.blocks_info.map(function(item){
    return convert_path_to_timeline_variables(item)
})[block_num], 
    
     
    }
     
    var break_block = {
        type: 'html-keyboard-response',
        stimulus: "here's the " + (task_block+1) + " break block!",
        trial_duration: 1000,
        choices: jsPsych.NO_KEYS
        
    }
     
     
     
     timeline.push(task_block)
     timeline.push(break_block)
 }
  
}
  

  
  
  
  
  
    
    
    //TO FIX!!!
    function saveData(name, data){
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '../../../cgi-bin/RR_adults/write_data.php'); // langcog server path
        //xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify({filename: name, filedata: data}));
    }
    
    
jsPsych.init({
        timeline: timeline,
        //use_webaudio: true, // this won't work for local testing (CORS), but maybe on server
        //preload_audio: audio,
        //preload_images: images,
        //preload_video: video,
        on_trial_finish: function(){
            saveData("cultureRR1-" + subject_id, jsPsych.data.get().csv());
            jsPsych.data.displayData();
            //setTimeout(function() { turk.submit(jsPsych.data.get().ignore('external-html').json()); }, 5000);
      }
    })

    </script>
</html>