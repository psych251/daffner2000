<!DOCTYPE html>
<html>
<head>
  <script src="js/jspsych.js"></script>
  <script src="js/jspsych-stimulus-presentation.js"></script>
  <script src="js/jspsych-instructions.js"></script>
    <script src="js/jspsych-html-keyboard-response.js"></script>
    <script src="js/jspsych-image-keyboard-response.js"></script>
    <script src= "js/jspsych-demog-age.js"></script>
    <script src= "js/jspsych-demog-ethnic-US.js"></script>
    <script src= "js/jspsych-demog-gender-and-education.js"></script>
    <script src= "js/jspsych-demog-disorder-history.js"></script>
    <script src="js/helper_for_generating_stimuli_array.js"></script>
    <script src="js/helper_for_checking_duplicate_stimuli.js"></script>
  <link rel="stylesheet" href="css/jspsych.css"></link>
</head>
<body></body>
<script>
    
    
    var timenum = Date.now();
    var turkInfo = jsPsych.turk.turkInfo();
    //$.getJSON('https://json.geoiplookup.io/api?callback=?', function(data) {
      //console.log(JSON.stringify(data, null, 2));
     // jsPsych.data.addProperties({ IP: data.ip, country_code: data.country_code });
    //});

    // if we're not on MTurk, create a timestamp-based subject number; otherwise use turker ID
    var subject_id = 'SS' + timenum;

    //console.log(turkInfo.workerId)
    if(turkInfo.workerId === "") {
      console.log(turkInfo.workerId)
      var subject_id = 'SS' + timenum;
    } else {
      var subject_id = 'MT-' + turkInfo.workerId;
    }
    
    // store subject in data on every trial
    jsPsych.data.addProperties({ subject: subject_id });

    
  var timeline = []
    
  



// this function random selects [number] of path in the [type] folder and return them in an array    
// the returned array represents all stimuli to be used in a task (5 blocks)

var NUM_SIMPLE_STIMULI = 120
var NUM_COMPLEX_STIMULI = 120


ALL_STIMULI_PATH = get_all_stimuli() // all stimuli 
stimuli_tracker = ALL_STIMULI_PATH // make a copy to keep track of stimuli that has been chosen


var simple_test_blocks = create_all_stimuli(meta_stimuli_path = stimuli_tracker, 
                                            type = "all_simple", 
                                            n_trial = 15, 
                                            n_block = 5, 
                                            bkgd_freq = 0.7,
                                            tg_freq = 0.15, 
                                            dvt_freq = 0.15)
stimuli_tracker = simple_test_blocks.remaining_stimuli

var complex_test_blocks = create_all_stimuli(meta_stimuli_path = stimuli_tracker,
                                             type = "all_complex", 
                                            n_trial = 15, 
                                            n_block = 5, 
                                            bkgd_freq = 0.7,
                                            tg_freq = 0.15, 
                                            dvt_freq = 0.15)
stimuli_tracker = complex_test_blocks.remaining_stimuli

var mixed_simple_test_blocks = create_all_stimuli(meta_stimuli_path = stimuli_tracker,
                                           type = "mixed_simple_deviant", 
                                           n_trial = 15, 
                                            n_block = 5, 
                                            bkgd_freq = 0.7,
                                            tg_freq = 0.15, 
                                            dvt_freq = 0.15)

var mixed_complex_test_blocks = create_all_stimuli(meta_stimuli_path = stimuli_tracker,
                                           type = "mixed_complex_deviant", 
                                           n_trial = 15, 
                                            n_block = 5, 
                                            bkgd_freq = 0.7,
                                            tg_freq = 0.15, 
                                            dvt_freq = 0.15)

// just double check there were no duplicates
var duplicate = check_duplicates([simple_test_blocks, complex_test_blocks, mixed_simple_test_blocks,mixed_complex_test_blocks])   
if (duplicate){
    alert("sampling script broken! detect duplicates!")
    assert()    
}

var ALL_TASKS = [simple_test_blocks,
                       complex_test_blocks, mixed_simple_test_blocks,mixed_complex_test_blocks]

shuffleArray(ALL_TASKS)
    

    

// minimum presentation time - done 
// various inter stimulus interval -- Done  
// presenting the target stimulus - done 
// presenting the target stimulus response => need to get conditional responses 

var current_block = ALL_TASKS[0] // this will be embedded in a larger loop 

const NUM_BLOCK = 5

for (var task_num = 0; task_num < ALL_TASKS.length; task_num++){

var current_task = ALL_TASKS[task_num]
var current_target = current_task.target    
    
console.log("current task")
     console.log(current_task)

 task_order_print = ""
 if (task_num === 0){
     task_order_print = "first"
 }else if (task_num === 1){
     task_order_print = "second"
 }else if (task_num === 2){
     task_order_print = "third"
 }else if (task_num === 3){
     task_order_print ="last"
 }
    
 var task_instruction = {
     type: "instructions",
     pages:[
         "hello!!!!",
         "look at pictures hahaha it's boring just press the down arrow", 
         "this is the target picture though press space bar pls" + '<p><img src="'+ current_target + '"></img></p>',
         "three tasks in total, you can take relatively longer break in between, each task has 5 small block, small break haha",
         "nope we will not test you just chill",
     ],
     show_clickable_nav: true
     
 }
 
 timeline.push(task_instruction)


 for (var block_num = 0; block_num < NUM_BLOCK; block_num++){
     
    current_target = current_task.target
     
    var task_block = {
    timeline: [
        
        {
            type: 'html-keyboard-response',
            stimulus: '<img src=images/blank.png width ="500" height = "600" style="border:5px solid black">',
            trial_duration: function(){ 
                var random_duration = 800 + 500 * Math.random()
                return random_duration  } , //The interval between the offset of one stimulus and the onset of the next stimulus ranged between 800 and 1300 msec
            choices: jsPsych.NO_KEYS
        },
        
        
       
        {
            type: 'stimulus-presentation',
            stimulus: function(){
                var html="<img src='"+jsPsych.timelineVariable('pic', true)+"' width ='500' height = '600' style='border:5px solid black'>";
                
                return html;
            },
            choices_for_target: [32],
            choices: [40],
            minimum_viewing_duration: 600, // daffner2000's info
            response_ends_trial: true, 
            task_type:current_task.type,
            task_target_stimulus:current_task.target,
         task_background_stimulus:current_task.background,
            task_deviant_stimulus:current_task.deviant,
            task_order_number:task_num,
            block_order_number:block_num,

        }],
        
    timeline_variables: current_task.blocks_info.map(function(item){
    return convert_path_to_timeline_variables(item)
})[block_num], 
    
     
    }
    
   
     
    var break_order = block_num + 1
    var break_block = {
        type: 'html-keyboard-response',
        stimulus: "here's the " + break_order + " break block!",
        trial_duration: 1000,
        choices: jsPsych.NO_KEYS
        
    }
     
     
     
     timeline.push(task_block)
     timeline.push(break_block)
 }
  
}
    
    
    
var final_instructions = {
     type: "instructions",
     pages:[
         "Finnally, we'd like to ask a few questions about you"
     ],
     show_clickable_nav: true
     
 }



    var demog_question_age = {
        type: 'demog-age',
        questions: [
        {prompt: "How old are you?", name: "age", required: true}
        ],
    }
    
     var demog_question_ethnicity = {
        type: "demog-ethnic-US", 
        button_label: "Done", 
        questions: [
            {prompt: "What is your racial or ethnic identification? Check all that apply.", name: "gender", options:  ["American Indian or Alaska Native", "Asian", "Black or African American", "Hispanic or Latino", "Native Hawaiian or Other Pacific Islander", "White", "Other"], required: true}
        ]
    }
     
    var demog_gender_and_education = {
        type: "demog-gender-and-education", 
        button_label: "Done", 
        questions: [
            {prompt: "What is your gender?", name: "gender", options: ["Female", "Male", "Non-binary", "Decline to Answer"], required: true}, 
            {prompt: "What is the highest degree or the higest level of school you have completed? If you are currently enrolled as a student, then please select the highest degree or education you have received.", name: "education", options: ["Some high school", "High school diploma", "Associate Degree/Technical certification", "Bachelor's Degree",  "Master's Degree", "Doctorate/Professional degree", "Other"], required: true}
        ]
    }
  
    var demog_disorder_history = {
        type: "demog-disorder-history", 
        button_label: "Done", 
        questions: [
            {prompt: "Do you currently have any neurological disorders?", name: "current_neuro", options: ["Yes", "No"], required: true}, 
            {prompt: "Have you had any neurological disorders in the past?", name: "past_neuro", options: ["Yes", "No"], required: true},
            {prompt: "Do you currently have any learning disabilities?", name: "current_ld", options: ["Yes", "No"], required: true},
            {prompt: "Have you had any history of learning disabilities in the past?", name: "past_ld", options: ["Yes", "No"], required: true}
        ]
    }
    
   var final_thank_you = {
     type: "instructions",
     pages:[
         "You are all done, thank you!"
     ],
     show_clickable_nav: false
     
 }    
  
   timeline.push(final_instructions)
   timeline.push(demog_question_age)
   timeline.push(demog_gender_and_education)
   timeline.push(demog_question_ethnicity)
   timeline.push(demog_disorder_history)
   timeline.push(final_thank_you)
   ///afs/ir.stanford.edu/users/a/n/anjiecao/cgi-bin/daffner2020/write_data.php
   
    //'../../../cgi-bin/RR_adults/write_data.php')
    //TO FIX!!!
    function saveData(name, data){
        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://web.stanford.edu/~anjiecao/cgi-bin/daffner2000/write_data.php'); 
        //xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify({filename: name, filedata: data}));
    }
    
    
jsPsych.init({
        timeline: timeline,
        //use_webaudio: true, // this won't work for local testing (CORS), but maybe on server
        //preload_audio: audio,
        preload_images: ALL_STIMULI_PATH,
        //preload_video: video,
        on_trial_finish: function(){
            saveData("daffnerrep-" + subject_id, jsPsych.data.get().csv());
            jsPsych.data.displayData();
            //setTimeout(function() { turk.submit(jsPsych.data.get().ignore('external-html').json()); }, 5000);
      }
    })

    </script>
</html>